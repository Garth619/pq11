jQuery.fn.repeater=function(e){var t=this;return t.options=jQuery.extend(!0,{},{template:"",limit:5,items:[{}],saveEvents:"blur change",saveElements:"input, select",addButtonMarkup:"+",removeButtonMarkup:"-",minItemCount:1,callbacks:{save:function(){},beforeAdd:function(){},add:function(){},beforeAddNew:function(){},addNew:function(){},beforeRemove:function(){},remove:function(){},repeaterButtons:function(){return!1}}},e),t.elem=jQuery(this),t.items=t.options.items,t.callbacks=t.options.callbacks,t._template=t.options.template,t._baseObj=t.items[0],t.init=function(){return t.stashTemplate(),t.elem.addClass("repeater"),t.refresh(),t.bindEvents(),t},t.bindEvents=function(){t.options.saveEvents=t.getNamespacedEvents(t.options.saveEvents),t.elem.off("click.repeater","a.add-item"),t.elem.on("click.repeater","a.add-item:not(.inactive)",(function(){t.addNewItem(this)})),t.elem.off("click.repeater","a.remove-item"),t.elem.on("click.repeater","a.remove-item",(function(e){t.removeItem(this)})),t.elem.off(t.options.saveEvents,t.options.saveElements),t.elem.on(t.options.saveEvents,t.options.saveElements,(function(){t.save()}))},t.stashTemplate=function(){t._template||(t._template=t.elem.html()),t._template=jQuery.trim(t._template)},t.addItem=function(e,n){var a=t.getItemMarkup(e,n),r=jQuery(a).addClass("item-"+n);t.callbacks.beforeAdd(t,r,e,n),t.append(r),t.populateSelects(e,n),t.callbacks.add(t,r,e,n)},t.getItemMarkup=function(e,n){var a=t._template;for(var r in e)e.hasOwnProperty(r)&&(a=(a=(a=a.replace(/{i}/g,n)).replace("{buttons}",t.getRepeaterButtonsMarkup(n))).replace(new RegExp("{"+r+"}","g"),escapeAttr(e[r])));return a},t.getRepeaterButtonsMarkup=function(e){var n=t.callbacks.repeaterButtons(t,e);return n||(n=t.getDefaultButtonsMarkup(e)),n},t.getDefaultButtonsMarkup=function(e){var n='<a class="add-item '+(t.items.length>=t.options.limit&&0!==t.options.limit?"inactive":"")+'" data-index="'+e+'">'+t.options.addButtonMarkup+"</a>";return t.items.length>t.options.minItemCount&&(n+='<a class="remove-item" data-index="'+e+'">'+t.options.removeButtonMarkup+"</a>"),'<div class="repeater-buttons">'+n+"</div>"},t.populateSelects=function(e,n){for(var a in e)if(e.hasOwnProperty(a)){var r=t.elem.find("."+a+"_"+n);r.is("select")&&(jQuery.isArray(e[a])?r.val(e[a]):r.find('option[value="'+e[a]+'"]').prop("selected",!0))}},t.addNewItem=function(e,n){var a=t.isElement(e),r=(n=parseInt(void 0!==n?n:a?parseInt(jQuery(e).attr("data-index"),10)+1:t.items.length,10),a?t.getBaseObject():e);return t.callbacks.beforeAddNew(t,n),t.items.splice(n,0,r),t.callbacks.addNew(t,n),t.refresh().save(),t},t.removeItem=function(e){var n=t.isElement(e)?jQuery(e).attr("data-index"):e;t.callbacks.beforeRemove(t,n),delete t.items[n],t.callbacks.remove(t,n),t.save().refresh()},t.refresh=function(){t.elem.empty();for(var e=0;e<t.items.length;e++)t.addItem(t.items[e],e);return t},t.save=function(){for(var e=t.getBaseObjectKeys(),n=[],a=0;a<t.items.length;a++)if(void 0!==t.items[a]){for(var r={},s=0;s<e.length;s++){var o=e[s],i="."+o+"_"+a,l=t.elem.find(i).val();r[o]=void 0!==l&&l}n.push(r)}return t.items=n,t.callbacks.save(t,n),t},t.getBaseObjectKeys=function(){for(var e=[],n=t.items.length>0?t.items:[t._baseObj],a=0;a<n.length;a++)if(void 0!==n[a]){for(var r in n[a])n[a].hasOwnProperty(r)&&e.push(r);break}return e},t.getBaseObject=function(){for(var e={},n=t.getBaseObjectKeys(),a=0;a<n.length;a++)e[n[a]]="";return e},t.getNamespacedEvents=function(e){e=e.split(" ");for(var t=[],n=0;n<e.length;n++)t.push(e[n]+".repeater");return t.join(" ")},t.isElement=function(e){try{return e instanceof HTMLElement}catch(t){return"object"==typeof e&&1===e.nodeType&&"object"==typeof e.style&&"object"==typeof e.ownerDocument}},t.init()};